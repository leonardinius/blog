---
layout: post
title: Jira - How to Include JSS and CSS resources on every page
date: 2010-12-07
comments: false
permalink: 2010/12/jira-how-to-include-jss-and-css.html
tags: [atlassian, jira, pdk]
---

Hi all,<br /><br /><blockquote>Disclaimer 1: The post and approach is 99% based on <a href="https://studio.plugins.atlassian.com/wiki/display/JBHV/JIRA+Behaviours+Plugin">Jira&nbsp;Behaviors&nbsp;Plugin</a>&nbsp;source code.</blockquote><blockquote>Disclaimer 2: The approach described here should be considered a hack/workaround and does not inline with Atlassian Jira Plugin structture and maintainability.&nbsp;</blockquote><blockquote><b>Update: </b>See the comments section. I would recommend better approach using Servlet Filter.&nbsp;</blockquote>You may find yourself requiring to either show/hide some part of Jira UI elements, or extend JIRA built-in edit/search capabilities. If it's custom field we are talking about - you might consider to implement Jira Custom Field (See <a href="http://confluence.atlassian.com/display/JIRA/How+to+create+a+new+Custom+Field+Type#HowtocreateanewCustomFieldType-AQuickCustomFieldTypesPrimer">Quick Custom Field Types Primer</a>&nbsp;on render options and capabilities).<br /><br />For some other cases - like <a href="http://blogs.onresolve.com/?author=3">Jamie Eclin</a>&nbsp;awesome Behaviors Plugin, or like in my example - hiding some always visible JIRA UI built-in &nbsp;elements - you might consider different approach to implement. Your options basically are:<br /><br /><ol><li>Hack and modify velocity/JSP file whatever does render the element in context. It even might be system level plugin - like system Issue operations. In some cases it might require JIRA instance restart and even re-compilation&nbsp;and re-deployment. And thus we will increase&nbsp;maintainability&nbsp;technical debt a lot.</li><li>We could manually configure&nbsp;<a href="http://confluence.atlassian.com/display/JIRA/Configuring+an+Announcement+Banner">Jira Announcement Banner</a>&nbsp;to include required resources on every page. Thus it will be one-time configuration option and it will be our responsibility to do so and maintain that piece of JSS/CSS snippet. In case our product consists of several plugins - we will endup with long list of configuration items + 1 more unrelated item - which is kind of implementation details only item. So, not so good afterwards (good enough for internal stuff, not so good for giving away).</li></ol><div>So, after reconsidering those options - I've chosen the second one + basically the Jamie Eclin approach on Behaviors Plugin. The main reasons to do so were:</div><div><ol><li>Not really a complete hack - could be implemented as valid Atlassian Plugin v2 plugin</li><li>Could be automated - no additional configuration needed</li><li>Source code for Behaviors Plugin is provided :)</li><li>See pt 3.</li></ol><div><br /><span class="Apple-style-span" style="font-size: large;">Implementation</span><br /><span class="Apple-style-span" style="font-size: large;"><br /></span><br /><b>1. Component</b><br />Simple interface with the only method - void setup(); Serves only as an entry point for resource injection during Jira startup procedure.<br /><br /><b>2. ComponentImpl</b><br />The actual component implementation. The purpose is to check whether Jira announcement banner already contains required JSS/CSS and it doesn't the inject them to the banner contents.<br /><pre><code class="java"><br />public class ComponentImpl implements Component, Startable {<br />    private static final String HIDE_CREATE_ISSUE_MARKER = "XYZ Plugin Marker - Do not modify!";<br />    private static final String CREATE_ISSUE_MARKER_START = "&lt;!-- --Start--[" + HIDE_CREATE_ISSUE_MARKER + "]--Start--";<br />    private static final String CREATE_ISSUE_MARKER_END = "&lt;!-- --End--[" + HIDE_CREATE_ISSUE_MARKER + "]--End-- --&gt;";<br /><br />    private final ApplicationProperties applicationProperties;<br /><br />    public ComponentImpl(ApplicationProperties applicationProperties) {<br />        this.applicationProperties = applicationProperties;<br />    }<br /><br />    @Override<br />    public void setup() throws RuntimeException {<br />        String alertHeader = applicationProperties.getDefaultBackedText(APKeys.JIRA_ALERT_HEADER);<br />        String injectedAlertHeader = installHideCreateIssue(alertHeader);<br />        if (!StringUtils.equals(alertHeader, injectedAlertHeader)) {<br />            applicationProperties.setText(APKeys.JIRA_ALERT_HEADER, injectedAlertHeader);<br />            //applicationProperties.setString(APKeys.JIRA_ALERT_HEADER_VISIBILITY, EditAnnouncementBanner.PUBLIC_BANNER);<br />        }<br />    }<br /><br />    @Override<br />    public void start() throws Exception {<br />        setup();<br />    }<br /><br />    <br />    private boolean isIncludesCreateIssueMarker(String input) {<br />        return StringUtils.contains(input, CREATE_ISSUE_MARKER_START)<br />                &amp;&amp; StringUtils.contains(input, CREATE_ISSUE_MARKER_END);<br />    }<br /><br />    String getInjection(String comment, String cssDefinitions, String javascript) {<br />        StringBuilder injection = new StringBuilder(CREATE_ISSUE_MARKER_START).append(comment).append(" --&gt;");<br /><br />        if (StringUtils.isNotBlank(cssDefinitions)) {<br />            injection = injection.append("\n&lt;style type=\"text/css\"&gt;\n")<br />                    .append(prepareCleanInject(cssDefinitions))<br />                    .append("\n&lt;/style&gt;");<br />        }<br /><br />        if (StringUtils.isNotBlank(javascript)) {<br />            injection = injection.append("\n&lt;script type=\"text/javascript\"&gt;\n")<br />                    .append(prepareCleanInject(javascript))<br />                    .append("\n&lt;/script&gt;");<br />        }<br /><br />        injection = injection.append(CREATE_ISSUE_MARKER_END);<br /><br />        return injection.toString();<br />    }<br /><br />    public String installHideCreateIssue(String alertHeader) throws RuntimeException {<br />        if (!isIncludesCreateIssueMarker(alertHeader)) {<br />            alertHeader = new StringBuilder()<br />                    // PROOF OF concept Items - it really should be done with Permission Schemes, not this hacky way<br />                    .append(getInjection("", "div#create-issue, div#createItem, ul#opsbar-edit li a#editIssue { display : none; }", ""))<br /><br />                    .append("\n")<br />                    .append(StringUtils.defaultString(alertHeader)).toString();<br />        }<br /><br />        return alertHeader;<br />    }<br />}<br /></code></pre><br /><b>3. atlassian-plugin.xml snippet</b><br /><b>Component and ComponentImpl registration snippet</b><br /><pre><code class="xml"><br />&lt;component key="myJSSCSSInjectionSnippet" name="My CSS/JSS injection snippet"<br />    class="com.xyz.ComponentImpl"&gt;<br />    &lt;interface&gt;com.xyz.Component&lt;/interface&gt;<br />&lt;/component&gt;<br /></code></pre><br />and Voile, we are done :)</div></div>
