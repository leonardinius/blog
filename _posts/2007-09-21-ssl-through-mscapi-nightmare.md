---
layout: post
title: SSL through MSCAPI nightmare
date: 2007-09-21
comments: false
page: 2007/09/ssl-through-mscapi-nightmare.html

---

<div style="text-align: justify;">Hi everybody,<br />Have everyone of you worked with SSL? It's really nightmare I tell you. Java+SSL stack (JKS and more and more abbreviations) seemed fine to me until our customer proposed the Windows user native keystore usage.<br /><span style="font-weight: bold;">The UC (use-case) outline summary: </span></div><ul style="text-align: justify;"><li>Users authenticates in Windows environment using some sort of the <a href="http://en.wikipedia.org/wiki/Single_sign-on">SSO</a> software installed onto client's machine.<br /></li><li>SSO puts it's certificate into Windows-MY keystore (<a href="http://en.wikipedia.org/wiki/MS_CAPI">CAPI</a>).</li><li>We provide some sort of service, which needs to access some data onto network using those authentication and authorization data (through HTTPS/SSL).</li></ul><div style="text-align: justify;"><span style="font-weight: bold;">Problem description:</span></div>Yep, we could use <a href="http://java.sun.com/javase/6/docs/technotes/guides/security/SunProviders.html#SunMSCAPI">MSCAPI provider</a> bundled with Jre1.6+. But in real case it doesn't work. For some strange reasons Sun's MSCAPI provider does not allow HTTPS through SSL.  For more deatiled information please visit: <a href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6578658">http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6578658</a>. The same issues is discussed at the:<br /><ul style="text-align: justify;"><li><a href="http://forum.java.sun.com/thread.jspa?forumID=60&amp;threadID=786782">http://forum.java.sun.com/thread.jspa?forumID=60&amp;threadID=786782</a></li><li><a href="http://forum.java.sun.com/thread.jspa?forumID=2&amp;threadID=5170899">http://forum.java.sun.com/thread.jspa?forumID=2&amp;threadID=5170899</a></li></ul>So, the straightforward solution: JKS framework + HTTPS - doesn't really work. Some other possible solutions could be: some 3rd papty JKS provider usage. For some strange reasons they all are not Open Source and Free/Beer-ware :) and they do not work either:<br /><ul style="text-align: justify;"><li><a href="http://rcardon.free.fr/websign">CAPIProv</a></li><li><a href="http://sourceforge.net/projects/jnicapi/">JNICapi SSL interface</a></li><li><a href="http://www.keyon.ch/en/Produkte/JavaJCE/JACAPI/index.htm">KeyOn JaCAPI</a></li><li><a href="http://pheox.com/products/jcapi/">Pheox JaCAPI</a></li></ul><div style="text-align: justify;"><div style="text-align: justify;"><span style="font-weight: bold;">Solutions proved to work well:</span><br />We could export MS CAPI My-Keystore certificates using MMC interface or through IE explorer /Tools/&nbsp;Content / Certificates interface:<br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://lh4.googleusercontent.com/-Jv9f9GyF-NM/TXXseJKSeJI/AAAAAAAAEKU/Pat9SemtDSE/s1600/2011-03-08_0938.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="https://lh4.googleusercontent.com/-Jv9f9GyF-NM/TXXseJKSeJI/AAAAAAAAEKU/Pat9SemtDSE/s1600/2011-03-08_0938.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">img 1 - Internet Explorer - Export Certificate wizard</td></tr></tbody></table><br /></div>At the image (img. 1.) we could clearly see the certificate beuing imported into My-keystore by SSO software. <span style="font-weight: bold;"><br /></span><br />By initiating export operation we could access the certificate chain + private key in the underlaying <a href="http://en.wikipedia.org/wiki/PKCS">.PFX</a> format. After that we could just to use standard JKS stack to authenticate and authorize using HTTPS over SSL.  <span style="font-weight: bold;">But.</span> Problem still remains: how to do this authomativally from JAVA side?<br />The solutions I have think out and developed is: some JNI code to export certificate to local file system. So:<br /><ul><li><a href="http://msdn2.microsoft.com/en-us/library/aa380395.aspx">CryptUIWizExport</a> is used to export MsCAPI certificates</li><li><a href="http://msdn2.microsoft.com/en-us/library/ms682396.aspx">CreateEvent </a> and <a href="http://msdn2.microsoft.com/en-us/library/ms687036.aspx">WaitForSingleObjectEx</a> are  used for change listener cycle together with <a href="http://msdn2.microsoft.com/en-us/library/aa376031.aspx">CertControleStore</a>.</li></ul><span style="font-size: 130%;"><span style="font-weight: bold;"><br />Conclusion, Java Part</span><br /></span><br /><div style="text-align: left;"><span style="font-size: 100%;">The part of our projet's semi-"official" wiki page:</span><br /><blockquote>All the logics and the functioality maximally is implemented onto JAVA side; among another things - listener cycle logics and so on.  The only thing being implemented onto the JNI part is WinAPI32 calls + a few functions to allocate/free/write to memory.<br /><ul><li>JAVA side uses JNI's provided calls to WinAPI to load and export all the certificates + their private keys to local temporaly files (with strong random password protection.)</li><li>Then those files are loaded into memory and gets removed.</li><li>SSL context is initialized from the memory.</li><li>A change listener is attached to the MsCAPI keystore. Then the Windows-MY keystore is changed (the certificate is added or loaded), a change event occurs and the overall SSL context state is reloaded and initialized again, resulting in completely new WS-SSO state.</li></ul></blockquote></div></div>
