---
layout: post
title: Atlassian Plugin SDK - how to provide optional selenium tests
date: 2011-02-21
comments: false
permalink: 2011/02/atlassian-plugin-sdk-how-to-provide.html
tags: [atlassian, tdd, pdk]
---

You probably are familiar with one of the most popular web UI testing tool - <a href="http://seleniumhq.org/">Selenium</a> and it's most famous tool <a href="http://seleniumhq.org/projects/ide/">Selenium IDE</a>.
<div>
</div><div><b><span class="Apple-style-span" style="font-size: large;">I don't want to read all this, give me the code</span></b></div><div><span class="Apple-style-span">You could find all the code you need on <a href="https://gist.github.com/836325#file_pom_updated.xml">github</a>.</span></div><div><span class="Apple-style-span">
</span></div><div><span class="Apple-style-span">Sorry for not embedding all the code in the article. That way the article becomes clumsy unreadable monster. If anyone could recommend me some collapsable/expandable solution - I would appreciate it a lot.</span></div><div><div>
<span class="Apple-style-span" style="font-size: large;"><b>Why do I need to bother with yet-another-testing-tool?</b></span>
The main advantages or features of the tools are (imo):
<ul><li>real UI behavior testing - tests are run inside the <b>real browser</b> and will fire/use real end-user key, mouse, etc events</li><li>ability to export the test in whole bunch of <b>programming languages</b> (java, python, ruby etc ...) </li><li>ability to run tests on <b>multiple target web-drivers</b> (firefox, internet explorer, etc ..)</li><li>Selenium IDE (mentioned earlier) is really nice tool which allows to create simple tests cases <b>very fast</b>, in few minutes or even seconds, literally</li><li>basically the only way to automate difficult <b>Ajax/RIA component</b> testing on different target environments; other httpUnit like approaches are not good enough</li></ul><b><span class="Apple-style-span" style="font-size: large;">How could I automate that?</span></b>
<span class="Apple-style-span">Selenium has child project - <a href="http://seleniumhq.org/projects/remote-control/">Selenium Remote Control</a> which could be used.</span>
<u><span class="Apple-style-span">Quote and image from </span>Selenium Remote Control site:</u>
<blockquote><span class="Apple-style-span"><span class="Apple-style-span" style="font-family: verdana, sans-serif; font-size: x-small; line-height: 16px;"></span></span>
<div style="line-height: 18px; margin-bottom: 0.6em; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span"><span class="Apple-style-span" style="font-family: verdana, sans-serif; font-size: x-small; line-height: 16px;">Selenium RC comes in two parts. </span></span></div><ol><li style="margin-bottom: 0.2em; margin-top: 0.2em;"><span class="Apple-style-span"><span class="Apple-style-span" style="font-family: verdana, sans-serif; font-size: x-small; line-height: 16px;">A server which automatically launches and kills browsers, and acts as a HTTP proxy for web requests from them.</span></span></li><span class="Apple-style-span"><span class="Apple-style-span" style="font-family: verdana, sans-serif; font-size: x-small; line-height: 16px;"><li style="margin-bottom: 0.2em; margin-top: 0.2em;">Client libraries for your favorite computer language.</li></span></span></ol></blockquote><div class="separator" style="clear: both; text-align: center;"><a href="http://selenium.openqa.org/selenium-rc.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="312" src="http://selenium.openqa.org/selenium-rc.png" width="320" /></a></div><div>
</div>Lucky to us, selenium has maven artifacts available to be used to plug-in into Atlassian PDK build procedure.
<b>Goals:</b>
<ol><li>make this optional (enabled by default) option</li><li>selenium-rc server side should be forked before integration tests will be executed</li><li>selenium-rc client side tests should be executed as part of the integration test suite</li><li>selenium-rc should be revoked upon integration-test completion</li></ol><b>Solution:</b>
<ol><li>is achieved by default maven profile (activated by !property)</li><li>is achieved by maven - specifying selenium-rc start-server g<span class="Apple-style-span" style="font-family: inherit;">oal to be run on <span class="Apple-style-span" style="line-height: 16px; white-space: pre;">pre-integration-test </span><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">phase</span></span></li><li><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">to achieve this please refer to Atlassian article - </span><span class="Apple-style-span" style="line-height: 16px; white-space: pre;"><a href="http://confluence.atlassian.com/display/DEVNET/Plugin+Tutorial+-+Writing+Integration+Tests+for+your+JIRA+plugin#PluginTutorial-WritingIntegrationTestsforyourJIRAplugin-Step6.WriteUnitandIntegrationTests">Writing Integration Tests</a></span><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">. Basically that means - you should put your code inside src/test/java/it/ folder and specifying proper locatest.properties file.</span></li><li><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">is achieved by maven - specifying that selenium-rc stop-server goal should be executed on post-integration-test phase.</span></li></ol><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">To get pom.xml file snippet - see this <a href="https://gist.github.com/836325#file_pom.xml">pom.xml gist</a></span></span><span class="Apple-style-span" style="font-family: inherit;">
</span>
<span class="Apple-style-span" style="font-family: inherit;"><b>How to check:</b></span>
execute <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">atlas-integration-test</span> command from the project home folder.

<b>Recommendations:</b>
Atlassian <a href="http://docs.atlassian.com/software/jira/docs/api/latest/func-test-javadoc/">FuncTestCase</a> (Jira in this case. There should be one for other Atlassian products as well) contains a lot of useful utilities and setup methods, which personally I've found very useful. So, the idea is to reuse it as much as possible. That could be done in you create your own abstract base MySeleniumTestCase which would contain <i>FuncTestCase</i> instance as <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">testHelper</span> member field and   would make it available via <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">getHelper()</span> or other similar way.
Still, you should use your own loginAs method on top of Selenium, cause helper object  will have different (not in-browser) http session.
<div>
Benefits:
<ul><li>ability to reuse utility methods (such as create new custom fields, restore from xml dump etc ..)</li><li>ability to configure your Selenium test against jira integration test environment - using helper to obtain JiraEvironmentData's host, port, context path etc..</li></ul><div>Unlucky I'm not able to share that piece of code, so you should to create it on your own. Still, it should be pretty straightforward, since all you need to do - is do declare member field and delegate to is in your test setUp/tearDown, as well as using it to configure your Selenium test host, port etc ..</div><div>
</div><b><span class="Apple-style-span" style="font-size: large;">Problems with Continuous Integration</span></b>
<span class="Apple-style-span">Ok, so we think we have automated our process so far and it runs locally. On my machine it launches internet explorer and executes the test. Awesome. The next thing is putting the test on our CI, which should be pretty straightforward, right? Wrong!</span>
<span class="Apple-style-span">Problems with CI:</span>
<ol><li>CI slave might be Linux terminal machine, no UI and therefore no real launch browser capabilities.</li><li>There is a bug with previous <span class="Apple-style-span" style="font-family: 'Courier New', Courier, monospace;">pom.xml</span> file. Yes, the profile is optional, however Atlassian PDK framework execute all the it/ tests regardless what type of tests are they, therefore all the Selenium tests will fail.</li></ol><div>The former one is solvable by using Selenium-RC <a href="http://mojo.codehaus.org/selenium-maven-plugin/examples/headless-with-xvfb.html">Headless X11 with XVFB</a> maven goal. The solution is to execute the goal on Linux  machine and skip one on a Windows box. That could be achieved by additional profile setting <a href="http://mojo.codehaus.org/selenium-maven-plugin/xvfb-mojo.html#skip">xvfb skip</a> flag to true and activated on windows platform only.</div><div>
</div><div>The later one could be solved by specifying AMPS plugin <a href="http://confluence.atlassian.com/display/DEVNET/AMPS+Plugin+for+Maven#AMPSPluginforMaven-testGroups">testGroups</a>. Using that we could specify different sets of independent functional tests, located in different locations (it/functests* and it/selenium/*). We could use <a href="http://confluence.atlassian.com/display/DEVNET/AMPS+Plugin+for+Maven#AMPSPluginforMaven-configuredTestGroupsToRun">configuredTestGroupsToRun</a> property as well, but I decided not to. </div><div>
</div><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 16px; white-space: pre;"><a href="https://gist.github.com/836325#file_pom.xml"></a></span><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">So, as a result we have completely independent sets of integration/functional tests, with ability to launch them all-together or pick just one of them. </span></span>
<span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 16px; white-space: pre;"> </span></span></div><div><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="font-size: large;"><b>The code</b></span></span></div><div><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">Please see <a href="https://gist.github.com/836325#file_pom_updated.xml">updated_pom.xml</a> file.  </span></span></div></div></div>
